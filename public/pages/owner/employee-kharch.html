<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üí∏ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ñ‡§∞‡•ç‡§ö (Optimized)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brand:#b53030;
  --highlight:#ffff99;
  --positive:#388e3c;
  --negative:#d32f2f;
}
*{box-sizing:border-box;}
body{margin:0;font-family:Poppins;background:#f4f6f9;}
header{background:var(--brand);color:#fff;padding:16px 20px;font-size:20px;font-weight:600;}
.container{max-width:1200px;margin:auto;padding:16px;}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.08);margin-bottom:20px;}
h3{margin-top:0;}
input,select{width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;margin-bottom:14px;font-size:15px;}
button{padding:14px 20px;border-radius:12px;border:none;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;position:relative;}
button.secondary{background:#eee;color:#333;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:700px;}
th{background:var(--brand);color:#fff;padding:14px;text-align:left;position:sticky;top:0;z-index:1;}
td{padding:14px;border-bottom:1px solid #eee;}
.owner-cell{color:var(--brand);font-weight:600;cursor:pointer;}
.owner-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;}
.owner-box{background:#fafafa;padding:16px;border-radius:14px;text-align:center;}
.owner-box span{display:block;margin-top:6px;font-size:22px;color:var(--brand);font-weight:700;}
.pagination{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-top:14px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;}
.modal-content{background:#fff;max-width:800px;margin:6% auto;padding:20px;border-radius:18px;max-height:80vh;overflow:auto;}
#toast{transition:all .4s ease;position:fixed;bottom:20px;right:20px;min-width:260px;padding:16px 18px;border-radius:14px;font-weight:600;color:#fff;display:none;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center;}
.spinner{width:18px;height:18px;border:3px solid #fff;border-top:3px solid rgba(255,255,255,0.4);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;margin-left:8px;vertical-align:middle;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.highlight{background:var(--highlight);}
@media(max-width:600px){
  header{font-size:18px;}
  .modal-content{margin:10% 12px;}
  .grid{grid-template-columns:1fr !important;}
  .grid input,.grid select{margin-bottom:10px;}
  button{width:100%;margin-top:10px;}
}
</style>
</head>
<body>

<header>üí∏ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ñ‡§∞‡•ç‡§ö (Optimized)</header>
<div class="container">

<!-- OWNER SUMMARY -->
<div class="card">
<h3>üëë Owner-wise ‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö</h3>
<div id="ownerSummary" class="owner-summary"></div>
</div>

<!-- ADD EXPENSE -->
<div class="card">
<h3>‚ûï ‡§ñ‡§∞‡•ç‡§ö ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
<div class="grid">
 <select id="employeeSelect"></select>
 <select id="ownerSelect"></select>
 <input type="number" id="amountInput" placeholder="‡§∞‡§æ‡§∂‡§ø">
 <input type="date" id="dateInput">
</div>
<button id="addExpenseBtn">‡§ñ‡§∞‡•ç‡§ö ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
</div>

<!-- FILTERS -->
<div class="card">
<h3>üîç ‡§ñ‡•ã‡§ú</h3>
<div class="grid">
 <input id="searchEmployee" placeholder="‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç">
 <input id="searchOwner" placeholder="Owner ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç">
</div>
</div>

<!-- TABLE -->
<div class="card">
<h3>üìä ‡§ñ‡§∞‡•ç‡§ö ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h3>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</th>
<th>ID</th>
<th>Owner</th>
<th>‡§∞‡§æ‡§∂‡§ø</th>
<th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
</tr>
</thead>
<tbody id="expenseTableBody"></tbody>
</table>
</div>
<div class="pagination">
 <div id="pageInfo"></div>
 <div>
  <button class="secondary" id="prevBtn">‚¨Ö</button>
  <button id="nextBtn">‚û°</button>
 </div>
</div>
</div>

</div>

<!-- OWNER MODAL -->
<div class="modal" id="ownerModal">
 <div class="modal-content">
  <h3 id="ownerModalTitle"></h3>
  <button class="secondary" onclick="closeOwnerModal()">Close</button>
  <div class="table-wrap">
   <table>
    <tbody id="ownerExpenseBody"></tbody>
   </table>
  </div>
 </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
/* -------------------- CACHE ELEMENTS -------------------- */
const employeeSelect = document.getElementById("employeeSelect");
const ownerSelect = document.getElementById("ownerSelect");
const amountInput = document.getElementById("amountInput");
const dateInput = document.getElementById("dateInput");
const addExpenseBtn = document.getElementById("addExpenseBtn");
const searchEmployee = document.getElementById("searchEmployee");
const searchOwner = document.getElementById("searchOwner");
const expenseTableBody = document.getElementById("expenseTableBody");
const ownerSummary = document.getElementById("ownerSummary");
const toast = document.getElementById("toast");
const ownerModal = document.getElementById("ownerModal");
const ownerModalTitle = document.getElementById("ownerModalTitle");
const ownerExpenseBody = document.getElementById("ownerExpenseBody");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");

/* -------------------- DATA -------------------- */
let allExpenses = [], filteredExpenses = [], ownerMap = new Map();
let page = 1, limit = 10, totalPages = 1;

/* -------------------- UTILITY -------------------- */
function formatCurrency(num){ return "‚Çπ"+Number(num||0).toLocaleString("hi-IN"); }
function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function highlight(text, query){ 
  if(!query) return text; 
  const regex = new RegExp(`(${escapeRegExp(query)})`,"gi"); 
  return text.replace(regex, `<span class="highlight">$1</span>`);
}
function debounce(fn, delay=200){ let timer; return (...args)=>{clearTimeout(timer); timer=setTimeout(()=>fn(...args),delay);} }
function showToast(msg, type="success"){
 toast.style.background = type==="success"?"#2e7d32":type==="error"?"#c62828":"#333";
 toast.innerText = msg;
 toast.style.display = "block"; toast.style.opacity="1"; toast.style.transform="translateY(0)";
 setTimeout(()=>{toast.style.opacity="0"; toast.style.transform="translateY(20px)";},2500);
 setTimeout(()=>{toast.style.display="none";},3000);
}

/* -------------------- LOAD EMPLOYEES & OWNERS -------------------- */
async function loadEmployees(){
 try{
   const r = await fetch("/api/employees/all");
   const j = await r.json();
   employeeSelect.innerHTML = "<option value=''>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option>";
   j.data.forEach(e=>{
     const opt = document.createElement("option");
     opt.value = e._id; opt.textContent = `${e.name} (${e.empId})`;
     employeeSelect.appendChild(opt);
   });
 } catch(e){ showToast("Error loading employees","error"); }
}

async function loadOwners(){
 try{
   const r = await fetch("/api/owners");
   const j = await r.json();
   ownerSelect.innerHTML = "<option value=''>Owner ‡§ö‡•Å‡§®‡•á‡§Ç</option>";
   j.forEach(o=>{
     const opt = document.createElement("option");
     opt.value = o.name; opt.textContent = o.name;
     ownerSelect.appendChild(opt);
   });
 } catch(e){ showToast("Error loading owners","error"); }
}

/* -------------------- LOAD EXPENSES -------------------- */
async function loadExpenses(){
 try{
   const r = await fetch("/api/expenses?limit=1000");
   let j;
   try{ j = await r.json(); } catch(e){ j = {data:[]}; showToast("Invalid JSON from server","error"); }
   allExpenses = j.data.map(e=>{
     const date = e.expenseDate?new Date(e.expenseDate):new Date(e.createdAt);
     e._formattedDate = e.expenseDate?date.toLocaleDateString("hi-IN"):date.toLocaleString("hi-IN",{weekday:"long", day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit"});
     return e;
   });
   filteredExpenses = [...allExpenses];
   precomputeOwnerMap();
   page=1; renderTable(); renderOwnerSummary(); updatePageInfo();
 } catch(e){ showToast("Failed to load expenses","error"); }
}

/* -------------------- PRECOMPUTE OWNER MAP -------------------- */
function precomputeOwnerMap(){
 ownerMap.clear();
 allExpenses.forEach(e=>{
   if(!ownerMap.has(e.ownerName)) ownerMap.set(e.ownerName, []);
   ownerMap.get(e.ownerName).push(e);
 });
}

/* -------------------- APPLY FILTERS -------------------- */
const applyFilters = debounce(()=>{
 const empQuery = searchEmployee.value.toLowerCase();
 const ownerQuery = searchOwner.value.toLowerCase();
 filteredExpenses = allExpenses.filter(e=>
   e.employee.name.toLowerCase().includes(empQuery) &&
   e.ownerName.toLowerCase().includes(ownerQuery)
 );
 page=1; renderTable(); renderOwnerSummary(); updatePageInfo();
},200);

/* -------------------- RENDER TABLE -------------------- */
function renderTable(){
 expenseTableBody.innerHTML="";
 const start = (page-1)*limit;
 const end = start+limit;
 const pageData = filteredExpenses.slice(start,end);
 if(pageData.length===0){ expenseTableBody.innerHTML="<tr><td colspan='5' style='text-align:center'>No expenses</td></tr>"; return; }
 const frag=document.createDocumentFragment();
 const empQuery=searchEmployee.value.toLowerCase();
 const ownQuery=searchOwner.value.toLowerCase();
 pageData.forEach(e=>{
   const tr=document.createElement("tr");
   tr.innerHTML=`
     <td>${highlight(e.employee.name, empQuery)}</td>
     <td>${e.employee.empId}</td>
     <td class="owner-cell" onclick="openOwnerModal('${e.ownerName}')">${highlight(e.ownerName, ownQuery)}</td>
     <td style="color:${e.amount>0?'var(--positive)':'var(--negative)'}">${formatCurrency(e.amount)}</td>
     <td>${e._formattedDate}</td>
   `;
   frag.appendChild(tr);
 });
 expenseTableBody.appendChild(frag);
 updatePageInfo();
}

/* -------------------- OWNER SUMMARY -------------------- */
function renderOwnerSummary(){
 const summaryMap = {};
 filteredExpenses.forEach(e=>summaryMap[e.ownerName] = (summaryMap[e.ownerName]||0)+e.amount);
 ownerSummary.innerHTML="";
 const frag=document.createDocumentFragment();
 Object.keys(summaryMap).sort((a,b)=>summaryMap[b]-summaryMap[a]).forEach(o=>{
   const div = document.createElement("div");
   div.className="owner-box";
   div.innerHTML = `<b>${o}</b><span>${formatCurrency(summaryMap[o])}</span>`;
   frag.appendChild(div);
 });
 ownerSummary.appendChild(frag);
}

/* -------------------- PAGINATION -------------------- */
function updatePageInfo(){
 const start = filteredExpenses.length===0?0:(page-1)*limit+1;
 const end = Math.min(page*limit, filteredExpenses.length);
 pageInfo.innerText=`Showing ${start}-${end} of ${filteredExpenses.length} entries`;
}
function nextPage(){ if(page*limit<filteredExpenses.length){ page++; renderTable(); } }
function prevPage(){ if(page>1){ page--; renderTable(); } }

/* -------------------- MODAL -------------------- */
function openOwnerModal(owner){
 ownerModal.style.display="block";
 ownerModalTitle.innerText = owner;
 ownerExpenseBody.innerHTML="";
 const frag = document.createDocumentFragment();
 const expenses = ownerMap.get(owner) || [];
 expenses.forEach(e=>{
   const tr = document.createElement("tr");
   tr.innerHTML = `<td>${e.employee.name}</td><td>${formatCurrency(e.amount)}</td><td>${e._formattedDate}</td>`;
   frag.appendChild(tr);
 });
 ownerExpenseBody.appendChild(frag);
}
function closeOwnerModal(){ ownerModal.style.display="none"; }

/* -------------------- ADD EXPENSE -------------------- */
async function addExpense(){
 const emp = employeeSelect.value, own = ownerSelect.value;
 const amt = amountInput.value, date = dateInput.value;
 if(!emp||!own||!amt){ showToast("‚ùå ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à","error"); return; }
 const orig = addExpenseBtn.innerHTML;
 addExpenseBtn.disabled = true; addExpenseBtn.innerHTML="‡§ú‡•ã‡§°‡§º ‡§∞‡§π‡•á ‡§π‡•à‡§Ç... <span class='spinner'></span>";
 try{
   const res = await fetch("/api/expenses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:emp,ownerName:own,amount:+amt,expenseDate:date||null})});
   const data = await res.json(); if(!res.ok) throw new Error(data.msg||"Server Error");
   amountInput.value=""; dateInput.value="";
   showToast("‚úî ‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ","success");
   await loadExpenses();
 } catch(err){ showToast("‚ùå "+err.message,"error"); }
 finally{ addExpenseBtn.disabled=false; addExpenseBtn.innerHTML=orig; }
}

/* -------------------- EVENTS -------------------- */
searchEmployee.oninput = applyFilters;
searchOwner.oninput = applyFilters;
addExpenseBtn.onclick = addExpense;
prevBtn.onclick = prevPage;
nextBtn.onclick = nextPage;
window.onclick = e=>{ if(e.target===ownerModal) ownerModal.style.display="none"; };

/* -------------------- INITIAL LOAD -------------------- */
loadEmployees(); loadOwners(); loadExpenses();
</script>

</body>
</html>
