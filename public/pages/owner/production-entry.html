<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üè≠ Production Entry</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--brand:#2e7d32;--brand-dark:#1b5e20;}
body{margin:0;font-family:Poppins,sans-serif;background:#f4f6f9;color:#333;}
.container{max-width:950px;margin:auto;padding:16px;}
.panel{background:#fff;padding:20px;border-radius:14px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,.08);}
.panel h3{margin:0 0 12px;color:var(--brand);}
.flex{display:flex;flex-wrap:wrap;gap:10px;}
input, select, button{padding:12px 14px;border-radius:8px;border:1px solid #ccc;font-size:0.95rem;}
button{background:var(--brand);color:#fff;border:none;cursor:pointer;transition:0.2s;}
button:hover{background:var(--brand-dark);}
button:disabled{opacity:0.6;cursor:not-allowed;}
.search-panel{margin-bottom:10px;}
.search-panel input{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:0.95rem;}
.total-bricks{background:#e8f5e9;color:var(--brand);font-weight:600;padding:12px;border-radius:8px;margin-bottom:10px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:10px;scroll-behavior:smooth;}
table{width:100%;border-collapse:collapse;margin-top:10px;min-width:600px;}
th, td{padding:10px;border-bottom:1px solid #ddd;text-align:left;white-space:nowrap;}
th{background:#f0f0f0;font-weight:600;}
.highlight{background:yellow;}
.pagination{display:flex;gap:5px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap;}
.page-btn{padding:5px 10px;border:1px solid var(--brand);color:var(--brand);border-radius:5px;cursor:pointer;}
.page-btn.disabled{opacity:0.5;cursor:not-allowed;}
#toast{position:fixed;bottom:20px;right:20px;min-width:260px;padding:16px 18px;border-radius:14px;font-weight:600;color:#fff;display:none;text-align:center;z-index:10000;transition:all .4s ease;}
.spinner{width:18px;height:18px;border:3px solid #fff;border-top:3px solid rgba(255,255,255,0.4);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;margin-left:8px;vertical-align:middle;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@media(max-width:600px){
  .flex{flex-direction:column;}
  input, select, button{width:100%; font-size:0.9rem; padding:10px;}
  th, td{padding:8px; font-size:0.85rem;}
  .total-bricks{font-size:0.95rem; padding:10px;}
}
</style>
</head>
<body>
<div class="container">

<!-- Production Entry -->
<section class="panel form-panel">
<h3>üè≠ Production Entry</h3>
<div class="flex">
<select id="prodEmployee"><option value="">‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option></select>
<input id="prodQty" type="number" placeholder="‡§à‡§Ç‡§ü ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ">
<input id="prodPrice" type="number" placeholder="‚Çπ ‡§™‡•ç‡§∞‡§§‡§ø ‡§à‡§Ç‡§ü">
<input id="prodDate" type="date">
<button id="addProdBtn">‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
</div>
</section>

<!-- Total Bricks -->
<div class="total-bricks" id="totalBricks">‡§ï‡•Å‡§≤ ‡§à‡§Ç‡§ü: 0</div>

<!-- Search -->
<div class="search-panel">
<input id="prodSearch" placeholder="‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§®‡§æ‡§Æ ‡§Ø‡§æ ID ‡§ñ‡•ã‡§ú‡•á‡§Ç">
</div>

<!-- Table -->
<div class="table-wrap">
<table>
<thead>
<tr>
<th>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</th>
<th>Qty</th>
<th>‚Çπ ‡§™‡•ç‡§∞‡§§‡§ø ‡§à‡§Ç‡§ü</th>
<th>‡§ï‡•Å‡§≤ ‚Çπ</th>
<th>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï / ‡§∏‡§Æ‡§Ø</th>
</tr>
</thead>
<tbody id="productionTableBody"></tbody>
</table>
<div class="pagination">
<button id="prevBtn" class="page-btn">Previous</button>
<span id="pageInfo"></span>
<button id="nextBtn" class="page-btn">Next</button>
</div>
</div>

</div>
<div id="toast"></div>

<script>
const apiBase = '/api';
let productionData = [];
let employeesMap = {};
let currentPage = 1;
const rowsPerPage = 10;

// Cached DOM
const prodEmployee = document.getElementById('prodEmployee');
const prodQty = document.getElementById('prodQty');
const prodPrice = document.getElementById('prodPrice');
const prodDate = document.getElementById('prodDate');
const addProdBtn = document.getElementById('addProdBtn');
const prodSearch = document.getElementById('prodSearch');
const tableBody = document.getElementById('productionTableBody');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');
const totalBricksEl = document.getElementById('totalBricks');
const toastEl = document.getElementById('toast');

// Toast
function showToast(msg,type='success'){
 toastEl.style.background=type==='success'? '#2e7d32': type==='error'? '#c62828':'#333';
 toastEl.innerText=msg; toastEl.style.display='block'; toastEl.style.opacity='1';
 if(type==='success'){ new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3').play().catch(()=>{}); navigator.vibrate?.(100);}
 if(type==='error'){ navigator.vibrate?.([200,100,200]);}
 setTimeout(()=>{toastEl.style.opacity='0';},2500);
 setTimeout(()=>{toastEl.style.display='none';},3000);
}

// Load employees
async function loadEmployees(){
 try{
  const res = await fetch(`${apiBase}/employees/all`);
  const j = await res.json();
  if(!j.data) throw new Error('Invalid JSON');
  prodEmployee.innerHTML = '<option value="">‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option>';
  j.data.forEach(e => {
    prodEmployee.innerHTML += `<option value="${e._id}">${e.name} (${e.empId})</option>`;
    employeesMap[e._id] = { name: e.name, empId: e.empId };
  });
 }catch(err){ showToast('Employee fetch failed','error'); }
}

// Fetch production
async function fetchProduction(){
 try{
  const res = await fetch(`${apiBase}/production`);
  const j = await res.json();
  productionData = Array.isArray(j)? j : j.data || [];
  displayTable();
 }catch(err){ showToast('Production fetch failed','error'); }
}

// Currency format
const formatCurrency = n=>'‚Çπ'+(n||0).toLocaleString('hi-IN');

// Format date
function formatDate(p){
 const dateObj = p.date ? new Date(p.date) : new Date(p.createdAt);
 return p.date ? dateObj.toLocaleDateString('hi-IN') : dateObj.toLocaleString('hi-IN',{ weekday:'long', day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

// Debounce
const debounce = (fn,delay=300)=>{ let timer; return (...args)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...args),delay); }};

// Display table
function displayTable(){
 const search = prodSearch.value.toLowerCase();
 const filtered = productionData.filter(p=>{
  const emp = p.employee?.name || employeesMap[p.employee]?.name || '';
  const empId = p.employee?.empId || employeesMap[p.employee]?.empId || '';
  return emp.toLowerCase().includes(search) || empId.toLowerCase().includes(search);
 });
 const totalPages = Math.ceil(filtered.length / rowsPerPage);
 if(currentPage>totalPages) currentPage = totalPages || 1;
 const start = (currentPage-1)*rowsPerPage;
 const paginated = filtered.slice(start,start+rowsPerPage);

 tableBody.innerHTML='';
 const frag = document.createDocumentFragment();
 paginated.forEach(p=>{
  const name = p.employee?.name || employeesMap[p.employee]?.name || '-';
  const empId = p.employee?.empId || employeesMap[p.employee]?.empId || '';
  const qty = p.qty || 0;
  const price = p.price || 0;
  const total = qty*price;
  const dateStr = formatDate(p);
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${highlightText(name,search)}</td><td>${qty}</td><td>${formatCurrency(price)}</td><td>${formatCurrency(total)}</td><td>${dateStr}</td>`;
  frag.appendChild(tr);
 });
 tableBody.appendChild(frag);

 pageInfo.textContent = `Page ${currentPage} of ${totalPages||1} | Total: ${filtered.length}`;
 computeTotalBricks(filtered);
}

// Highlight
function highlightText(text,search){
 if(!search) return text;
 return text.replace(new RegExp(`(${search})`,'gi'),'<span class="highlight">$1</span>');
}

// Compute total bricks
function computeTotalBricks(data){
 const total = data.reduce((acc,p)=>acc + (p.qty||0),0);
 totalBricksEl.textContent = `‡§ï‡•Å‡§≤ ‡§à‡§Ç‡§ü: ${total}`;
}

// Add production
addProdBtn.addEventListener('click', async ()=>{
 const employee = prodEmployee.value;
 const qty = +prodQty.value;
 const price = +prodPrice.value;
 const dateInputVal = prodDate.value;
 if(!employee || !qty || !price){ showToast('‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç','error'); return; }

 addProdBtn.disabled=true;
 const originalText = addProdBtn.textContent;
 addProdBtn.innerHTML='‚è≥ ‡§ú‡•ã‡§°‡§º ‡§∞‡§π‡•á ‡§π‡•à‡§Ç... <span class="spinner"></span>';

 const productionDate = dateInputVal ? (()=>{const d=new Date(dateInputVal);const now=new Date();d.setHours(now.getHours(), now.getMinutes(), now.getSeconds());return d;})() : null;

 try{
  const res = await fetch(`${apiBase}/production`,{
   method:'POST', headers:{'Content-Type':'application/json'},
   body:JSON.stringify({ employee, qty, price, date: productionDate })
  });
  const data = await res.json();
  if(!res.ok) throw new Error(data.msg || 'Server Error');
  if(!data.employee?.name) data.employee = employeesMap[employee] || {name:'-', empId:''};
  productionData.unshift(data);
  displayTable();
  prodQty.value=''; prodPrice.value=''; prodEmployee.value=''; prodDate.value='';
  showToast('Production Added!','success');
 }catch(err){ showToast(err.message,'error'); }
 finally{ addProdBtn.disabled=false; addProdBtn.textContent=originalText; }
});

// Pagination
prodSearch.addEventListener('input',debounce(()=>{ currentPage=1; displayTable(); }));
prevBtn.addEventListener('click',()=>{ if(currentPage>1){currentPage--; displayTable(); }});
nextBtn.addEventListener('click',()=>{ currentPage++; displayTable(); });

// Initial load
loadEmployees();
fetchProduction();
</script>
</body>
</html>
