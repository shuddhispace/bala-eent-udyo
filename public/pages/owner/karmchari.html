<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#ff5722;
  --primary-dark:#e64a19;
  --bg-light:#f5f5f5;
  --card-bg:#fff;
  --hover-bg:#ffe0b2;
  --highlight:#ffff99;
  --balance-positive:#388e3c;
  --balance-negative:#d32f2f;
  --text-color:#333;
  --border-color:#ccc;
}

/* Reset & Base */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif;}
body{background:var(--bg-light);padding:12px;color:var(--text-color);}
button, input{font-family:'Poppins',sans-serif;}
a{text-decoration:none;color:inherit;}

/* Panels */
.panel{
  background:var(--card-bg);
  padding:16px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  margin-bottom:16px;
}
.panel h2,h3{margin-bottom:12px;color:var(--primary-dark)}

/* Forms */
.panel form{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.panel label{font-size:14px;margin-bottom:4px;display:block;}
.panel input{
  flex:1 1 160px;
  padding:11px 12px;
  border-radius:10px;
  border:1px solid var(--border-color);
}
.panel input:focus{outline:none;border-color:var(--primary);}
.panel button{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:11px 14px;
  border-radius:10px;
  cursor:pointer;
}
.panel button:hover{background:var(--primary-dark);}

/* Controls */
.controls{
  display:flex;
  gap:10px;
  margin-bottom:12px;
  flex-wrap:wrap;
}
.controls input{flex:1 1 200px;}
.controls button{
  background:#888;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 12px;
  cursor:pointer;
}
.controls button:hover{background:#555;}
.controls button:disabled{opacity:0.6;cursor:not-allowed;}

/* Table */
.table-container{
  overflow-x:auto;
  border-radius:14px;
  max-width:100%;
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:1000px;
}
th,td{
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:left;
  font-size:14px;
}
th{
  background:var(--primary);
  color:#fff;
  position:sticky;
  top:0;
  z-index:1;
}
tbody tr:hover{background:var(--hover-bg);}
.highlight{background:var(--highlight);}
.balance-positive{color:var(--balance-positive);}
.balance-negative{color:var(--balance-negative);}

/* Pagination */
.pagination{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
}
.pagination button{
  padding:8px 14px;
  border-radius:10px;
  border:none;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
}
.pagination button:hover:not(:disabled){background:var(--primary-dark);}
.pagination button:disabled{background:#ccc;cursor:not-allowed;}

/* Toast */
.toast{
  padding:10px 14px;
  border-radius:10px;
  margin-bottom:8px;
  color:#fff;
  font-weight:500;
  opacity:0.95;
  animation:fadeIn 0.3s;
}
.toast.success{background:#388e3c}
.toast.error{background:#d32f2f}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(-10px);}
  to{opacity:0.95;transform:translateY(0);}
}

/* Modal */
.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.modal-content {
  background: #fff;
  padding: 20px 30px;
  border-radius: 12px;
  max-width: 400px;
  text-align: center;
}
.modal-content h3 {color: var(--primary-dark); margin-bottom:12px;}
.modal-content p {font-size:16px; margin-bottom:18px;}
.modal-content button {
  background: var(--primary);
  color: #fff;
  border:none;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
}
.modal-content button:hover{background:var(--primary-dark);}

/* Mobile adjustments */
@media(max-width:600px){
  th,td{font-size:13px}
  .panel form{flex-direction:column;gap:8px;}
  .panel form input, .panel form button{flex:1 1 100%;}
  .panel form button{padding:12px;font-size:16px;}
}
</style>
</head>
<body>

<div id="toastContainer"></div>

<section class="panel">
  <h3>‚ûï ‡§®‡§Ø‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</h3>
  <form id="addEmployeeForm">
    <label for="empName">‡§®‡§æ‡§Æ</label>
    <input id="empName" placeholder="‡§®‡§æ‡§Æ" required>
    <label for="empPhone">‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label>
    <input id="empPhone" placeholder="‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞" pattern="\d{10}">
    <label for="empAdvance">Advance ‚Çπ</label>
    <input id="empAdvance" type="number" placeholder="Advance ‚Çπ">
    <button type="submit">‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
  </form>
</section>

<section class="panel">
  <h2>üë∑ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</h2>
  <div class="controls">
    <input id="employeeSearch" placeholder="‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
    <button id="clearSearch" disabled>‚ùå Clear</button>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>‡§®‡§æ‡§Æ</th>
          <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
          <th>Joining Date</th>
          <th>Advance</th>
          <th>‡§ñ‡§∞‡•ç‡§ö</th>
          <th>‡§à‡§Ç‡§ü (Qty)</th>
          <th>‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‚Çπ</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody">
        <tr><td colspan="9">Loading employees‚Ä¶</td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4"><strong>‡§ï‡•Å‡§≤ (Page)</strong></td>
          <td id="tfootAdvance">‚Çπ0</td>
          <td id="tfootExpense">‚Çπ0</td>
          <td id="tfootBricks">0</td>
          <td id="tfootProduction">‚Çπ0</td>
          <td id="tfootBalance">‚Çπ0</td>
        </tr>
      </tfoot>
    </table>
  </div>
  <div class="pagination">
    <button id="prevPage">‚¨Ö Prev</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Next ‚û°</button>
  </div>
  <select id="pageLimitSelect">
    <option value="10">10 rows</option>
    <option value="20">20 rows</option>
    <option value="50">50 rows</option>
  </select>
</section>

<div id="employeeAddedModal" class="modal">
  <div class="modal-content">
    <h3>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ</h3>
    <p id="modalEmployeeInfo"></p>
    <button id="closeModalBtn">OK</button>
  </div>
</div>

<script>
const API="/api";
const employeeTableBody=document.getElementById("employeeTableBody");
const employeeSearch=document.getElementById("employeeSearch");
const addEmployeeForm=document.getElementById("addEmployeeForm");
const empName=document.getElementById("empName");
const empPhone=document.getElementById("empPhone");
const empAdvance=document.getElementById("empAdvance");
const clearSearch=document.getElementById("clearSearch");
const prevBtn=document.getElementById("prevPage");
const nextBtn=document.getElementById("nextPage");
const pageInfo=document.getElementById("pageInfo");
const pageLimitSelect=document.getElementById("pageLimitSelect");
const tfootAdvance=document.getElementById("tfootAdvance");
const tfootExpense=document.getElementById("tfootExpense");
const tfootBricks=document.getElementById("tfootBricks");
const tfootProduction=document.getElementById("tfootProduction");
const tfootBalance=document.getElementById("tfootBalance");
const employeeAddedModal = document.getElementById("employeeAddedModal");
const modalEmployeeInfo = document.getElementById("modalEmployeeInfo");
const closeModalBtn = document.getElementById("closeModalBtn");
const toastContainer=document.getElementById("toastContainer");

let allEmployees=[], filteredEmployees=[], currentPage=1, pageLimit=10, isLoading=false;

/* DATE FORMAT */
function formatDateTime(dateStr){
  if(!dateStr) return "-";
  const d=new Date(dateStr);
  return d.toLocaleString("hi-IN",{ weekday:"short", day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit"});
}

/* TOAST */
function showToast(msg,type){
  const t=document.createElement("div");
  t.className=`toast ${type}`;
  t.innerText=msg;
  toastContainer.appendChild(t);
  setTimeout(()=>t.remove(),4000);
}

/* DEBOUNCE */
function debounce(fn, delay){
  let timer;
  return (...args)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...args),delay);}
}

/* RENDER EMPLOYEES */
function renderEmployees(list){
  employeeTableBody.innerHTML="";
  const start=(currentPage-1)*pageLimit;
  const end=start+pageLimit;
  const pageList=list.slice(start,end);

  let adv=0,exp=0,prod=0,bal=0,bricks=0;
  if(pageList.length===0){
    employeeTableBody.innerHTML=`<tr><td colspan="9">No employees</td></tr>`;
    tfootAdvance.innerText="‚Çπ0"; tfootExpense.innerText="‚Çπ0"; tfootBricks.innerText="0";
    tfootProduction.innerText="‚Çπ0"; tfootBalance.innerText="‚Çπ0";
    pageInfo.innerText="Page 0 of 0";
    prevBtn.disabled=nextBtn.disabled=true;
    return;
  }

  const query=employeeSearch.value.trim().toLowerCase();
  clearSearch.disabled=!query;

  const fragment=document.createDocumentFragment();

  pageList.forEach(e=>{
    const advance=Number(e.advance||0);
    const expense=Number(e.totalExpense||0);
    const production=Number(e.totalProduction||0);
    const totalBricks=Number(e.totalBricks||0);
    const balance=Number(e.balance ?? (advance+production-expense));

    adv+=advance; exp+=expense; prod+=production; bal+=balance; bricks+=totalBricks;

    const tr=document.createElement("tr");
    const highlight=(text)=>{
      if(!query) return text||"-";
      const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex=new RegExp(`(${safeQuery})`,"gi");
      return (text||"-").toString().replace(regex,`<span class="highlight">$1</span>`);
    }

    tr.innerHTML=`
      <td>${highlight(e.empId||"-")}</td>
      <td>${highlight(e.name)}</td>
      <td>${highlight(e.phone)}</td>
      <td>${formatDateTime(e.joiningDate)}</td>
      <td>‚Çπ${advance}</td>
      <td>‚Çπ${expense}</td>
      <td>${totalBricks}</td>
      <td>‚Çπ${production}</td>
      <td class="${balance>0?'balance-positive':balance<0?'balance-negative':''}">‚Çπ${balance}</td>
    `;
    fragment.appendChild(tr);
  });

  employeeTableBody.appendChild(fragment);

  tfootAdvance.innerText="‚Çπ"+adv;
  tfootExpense.innerText="‚Çπ"+exp;
  tfootBricks.innerText=bricks;
  tfootProduction.innerText="‚Çπ"+prod;
  tfootBalance.innerText="‚Çπ"+bal;

  const totalPages=Math.ceil(list.length/pageLimit)||1;
  pageInfo.innerText=`Page ${currentPage} of ${totalPages}`;
  prevBtn.disabled=currentPage<=1;
  nextBtn.disabled=currentPage>=totalPages;
}

/* FILTER EMPLOYEES - GLOBAL SEARCH */
const filterEmployees=debounce(()=>{
  const query=employeeSearch.value.trim().toLowerCase();
  filteredEmployees=allEmployees.filter(e=>{
    return (e.name && e.name.toLowerCase().includes(query)) || 
           (e.empId && e.empId.toString().includes(query)) ||
           (e.phone && e.phone.includes(query));
  });
  currentPage=1;
  renderEmployees(filteredEmployees);
},200);

/* LOAD EMPLOYEES */
async function loadEmployees(){
  if(isLoading) return;
  isLoading=true;
  employeeTableBody.innerHTML=`<tr><td colspan="9">Loading employees‚Ä¶</td></tr>`;
  try{
    const res=await fetch(`${API}/employees?limit=1000`);
    let data=[];
    try { data = await res.json(); } catch(e){ data=[]; }
    allEmployees=Array.isArray(data.data)?data.data: Array.isArray(data)?data: [];
    filteredEmployees=[...allEmployees];
    renderEmployees(filteredEmployees);
  }catch(err){
    showToast("Failed to load employees","error");
    employeeTableBody.innerHTML=`<tr><td colspan="9">Error loading data</td></tr>`;
  }finally{isLoading=false;}
}

/* ADD EMPLOYEE */
addEmployeeForm.onsubmit=async e=>{
  e.preventDefault();
  const newEmployee={ name: empName.value.trim(), phone: empPhone.value.trim(), advance: Number(empAdvance.value) };
  if(!newEmployee.name){ showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç","error"); return; }

  try{
    const res=await fetch(`${API}/employees`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(newEmployee)
    });
    if(res.ok){
      const data = await res.json();
      empName.value=empPhone.value=empAdvance.value="";
      modalEmployeeInfo.innerHTML=`<strong>ID:</strong> ${data.empId||"-"}<br><strong>Name:</strong> ${data.name||newEmployee.name}`;
      employeeAddedModal.style.display="flex";
      setTimeout(()=>employeeAddedModal.style.display="none",3000);
      loadEmployees();
    }else{
      const errData=await res.json();
      showToast(`Failed to add employee: ${errData.message||"Server error"}`,"error");
    }
  }catch(err){ showToast("Network error: Unable to add employee","error"); }
}

/* Modal close */
closeModalBtn.onclick=()=>employeeAddedModal.style.display="none";

/* Events */
employeeSearch.oninput=filterEmployees;
clearSearch.onclick=()=>{ employeeSearch.value=""; filteredEmployees=[...allEmployees]; currentPage=1; renderEmployees(filteredEmployees); }
prevBtn.onclick=()=>{ currentPage--; renderEmployees(filteredEmployees); }
nextBtn.onclick=()=>{ currentPage++; renderEmployees(filteredEmployees); }
pageLimitSelect.onchange=e=>{ pageLimit=+e.target.value; currentPage=1; renderEmployees(filteredEmployees); }

/* INITIAL LOAD */
loadEmployees();
</script>
</body>
</html>
