<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‚Ä¢ ‡§ñ‡§∞‡•ç‡§ö ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #ff5722;
  --primary-dark: #e64a19;
  --secondary: #ffc107;
  --bg-light: #f5f5f5;
  --card-bg: #fff;
  --hover-bg: #ffe0b2;
  --error-color: #d32f2f;
  --success-color: #388e3c;
  --transition: 0.3s;
}

* { box-sizing:border-box; margin:0; padding:0; font-family:'Poppins',sans-serif; }
body { background:var(--bg-light); color:#333; padding:20px; }

/* PANEL */
.panel { background:var(--card-bg); padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
.panel h3 { margin-bottom:15px; color:var(--primary-dark); }
.panel h2 { margin-bottom:10px; color:var(--primary-dark); }

/* FORM */
.panel form { display:flex; flex-wrap:wrap; gap:10px; }
.panel input, .panel select, .panel button { padding:10px; border-radius:8px; border:1px solid #ccc; font-size:0.9rem; }
.panel button { background:var(--primary); color:#fff; border:none; cursor:pointer; transition:var(--transition); }
.panel button:hover { background:var(--primary-dark); }

/* TABLE */
.table-container { overflow-x:auto; background:var(--card-bg); border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
table { width:100%; border-collapse:collapse; }
th, td { padding:12px 10px; border-bottom:1px solid #ddd; text-align:left; font-size:0.9rem; }
th { background:var(--primary); color:#fff; font-weight:500; }
tr:hover { background:var(--hover-bg); }

/* PAGINATION */
.pagination { display:flex; justify-content:center; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap; }
.pagination button { padding:6px 12px; border:none; border-radius:8px; background:var(--primary); color:#fff; cursor:pointer; }
.pagination button:disabled { background:#ccc; cursor:not-allowed; }

/* ALERTS */
.toast { padding:10px 15px; border-radius:8px; margin-bottom:10px; color:#fff; font-weight:500; transition:opacity 0.3s; }
.toast.success { background:var(--success-color); }
.toast.error { background:var(--error-color); }

/* MODAL */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 6px 18px rgba(0,0,0,0.15); }
.modal-content h3 { margin-bottom:15px; color:var(--primary-dark); }
.modal-content input, .modal-content select, .modal-content button { width:100%; margin-bottom:10px; padding:8px; border-radius:8px; border:1px solid #ccc; }
.modal-content button { background:var(--primary); color:#fff; border:none; cursor:pointer; transition:var(--transition); }
.modal-content button:hover { background:var(--primary-dark); }
</style>
</head>
<body>

<div id="toastContainer"></div>

<!-- ===== ADD EMPLOYEE ===== -->
<section class="panel form-panel">
  <h3>‚ûï ‡§®‡§Ø‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</h3>
  <form id="addEmployeeForm">
    <input id="empName" placeholder="‡§®‡§æ‡§Æ" required>
    <input id="empPhone" placeholder="‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞">
    <input id="empAdvance" type="number" placeholder="Advance ‚Çπ">
    <button type="submit">‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
  </form>
</section>

<!-- ===== EMPLOYEE LIST ===== -->
<section class="panel">
  <h2>üë∑ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</h2>

  <div class="controls" style="margin-bottom:10px;">
    <input type="text" id="employeeSearch" placeholder="‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
    <button id="addExpenseBtn">‡§ñ‡§∞‡•ç‡§ö ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>‡§®‡§æ‡§Æ</th>
          <th>Advance</th>
          <th>‡§ñ‡§∞‡•ç‡§ö</th>
          <th>‡§à‡§Ç‡§ü (Qty)</th>
          <th>‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‚Çπ</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody">
        <tr><td colspan="7">Loading employees‚Ä¶</td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2"><strong>‡§ï‡•Å‡§≤ (Page)</strong></td>
          <td id="tfootAdvance">‚Çπ0</td>
          <td id="tfootExpense">‚Çπ0</td>
          <td id="tfootBricks">0</td>
          <td id="tfootProduction">‚Çπ0</td>
          <td id="tfootBalance">‚Çπ0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="pagination">
    <button id="prevPage">‚¨Ö Prev</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Next ‚û°</button>
    <button id="showAll">Show All</button>
  </div>

  <select id="pageLimitSelect">
    <option value="10">10 rows</option>
    <option value="20">20 rows</option>
    <option value="50">50 rows</option>
  </select>
</section>

<!-- ===== ADD EXPENSE MODAL ===== -->
<div class="modal" id="expenseModal">
  <div class="modal-content">
    <h3>‡§ñ‡§∞‡•ç‡§ö ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
    <select id="modalEmployee">
      <option value="">‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option>
    </select>
    <select id="modalOwner">
      <option value="">Owner ‡§ö‡•Å‡§®‡•á‡§Ç</option>
    </select>
    <input type="number" id="modalAmount" placeholder="‡§∞‡§æ‡§∂‡§ø ‚Çπ">
    <input type="text" id="modalNote" placeholder="‡§®‡•ã‡§ü">
    <button id="modalSaveBtn">‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
    <button id="modalCloseBtn">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
  </div>
</div>

<script>
const API = "/api";

const employeeTableBody = document.getElementById("employeeTableBody");
const employeeSearch = document.getElementById("employeeSearch");
const addEmployeeForm = document.getElementById("addEmployeeForm");
const empName = document.getElementById("empName");
const empPhone = document.getElementById("empPhone");
const empAdvance = document.getElementById("empAdvance");

const expenseModal = document.getElementById("expenseModal");
const modalEmployee = document.getElementById("modalEmployee");
const modalOwner = document.getElementById("modalOwner");
const modalAmount = document.getElementById("modalAmount");
const modalNote = document.getElementById("modalNote");
const modalSaveBtn = document.getElementById("modalSaveBtn");
const modalCloseBtn = document.getElementById("modalCloseBtn");

const prevBtn = document.getElementById("prevPage");
const nextBtn = document.getElementById("nextPage");
const showAllBtn = document.getElementById("showAll");
const pageInfo = document.getElementById("pageInfo");
const pageLimitSelect = document.getElementById("pageLimitSelect");
const addExpenseBtn = document.getElementById("addExpenseBtn");

let employees = [];
let owners = [];
let currentPage = 1;
let pageLimit = 10;
let totalEmployees = 0;

// ===== LOAD OWNERS =====
async function loadOwners(){
  const res = await fetch(`${API}/owners`);
  owners = await res.json();
  modalOwner.innerHTML='<option value="">Owner ‡§ö‡•Å‡§®‡•á‡§Ç</option>';
  owners.forEach(o=>{
    modalOwner.innerHTML+=`<option value="${o._id}">${o.name}</option>`;
  });
}

// ===== LOAD EMPLOYEES =====
async function loadEmployees(showAll=false){
  const url = showAll ? `${API}/employees/all` : `${API}/employees?page=${currentPage}&limit=${pageLimit}`;
  const res = await fetch(url);
  const data = await res.json();
  employees = data.data || [];
  totalEmployees = data.totalCount || employees.length;
  renderEmployees(employees);
  updatePagination();
  fillEmployeeSelect(); // always show all employees in modal
}

// ===== RENDER EMPLOYEES TABLE =====
function renderEmployees(list){
  employeeTableBody.innerHTML="";
  if(list.length===0){
    employeeTableBody.innerHTML='<tr><td colspan="7">No employees found</td></tr>';
    return;
  }
  let adv=0,exp=0,prod=0,bal=0,bricks=0;
  list.forEach(e=>{
    adv+=e.advance||0; exp+=e.totalExpense||0; prod+=e.totalProduction||0;
    bal+=e.balance||0; bricks+=e.totalBricks||0;
    employeeTableBody.innerHTML+=`<tr>
      <td>${e.empId}</td>
      <td>${e.name}</td>
      <td>‚Çπ${e.advance||0}</td>
      <td>‚Çπ${e.totalExpense||0}</td>
      <td>${e.totalBricks||0}</td>
      <td>‚Çπ${e.totalProduction||0}</td>
      <td>‚Çπ${e.balance||0}</td>
    </tr>`;
  });
  document.getElementById("tfootAdvance").innerText="‚Çπ"+adv;
  document.getElementById("tfootExpense").innerText="‚Çπ"+exp;
  document.getElementById("tfootProduction").innerText="‚Çπ"+prod;
  document.getElementById("tfootBalance").innerText="‚Çπ"+bal;
  document.getElementById("tfootBricks").innerText=bricks;
}

// ===== FILL EMPLOYEE SELECT FOR EXPENSE (ALL EMPLOYEES) =====
async function fillEmployeeSelect(){
  try{
    const res = await fetch(`${API}/employees/all`);
    const data = await res.json();
    modalEmployee.innerHTML='<option value="">‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option>';
    (data.data || []).forEach(e=>{
      modalEmployee.innerHTML+=`<option value="${e._id}">${e.name}</option>`;
    });
  }catch(err){
    console.error("Employee fetch failed:", err);
    showToast("Employee fetch failed", "error");
  }
}

// ===== ADD EMPLOYEE =====
addEmployeeForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const name = empName.value.trim();
  const phone = empPhone.value.trim();
  const advance = Number(empAdvance.value);
  if(!name) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç");

  const res = await fetch(`${API}/employees`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name, phone, advance})
  });

  if(res.ok){
    showToast("‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ", "success");
    empName.value=""; empPhone.value=""; empAdvance.value="";
    loadEmployees();
  }else{
    showToast("‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", "error");
  }
});

// ===== PAGINATION =====
function updatePagination(){
  const totalPages = Math.ceil(totalEmployees / pageLimit) || 1;
  pageInfo.innerText=`Page ${currentPage} of ${totalPages}`;
  prevBtn.disabled=currentPage<=1;
  nextBtn.disabled=currentPage>=totalPages;
}
prevBtn.onclick=()=>{if(currentPage>1){currentPage--;loadEmployees();}};
nextBtn.onclick=()=>{currentPage++;loadEmployees();};
showAllBtn.onclick=()=>{currentPage=1;loadEmployees(true);};
pageLimitSelect.onchange=e=>{pageLimit=Number(e.target.value);currentPage=1;loadEmployees();};

// ===== SEARCH =====
employeeSearch.oninput=e=>{
  const v=e.target.value.toLowerCase();
  renderEmployees(employees.filter(x=>x.name.toLowerCase().includes(v)));
};

// ===== EXPENSE MODAL =====
addExpenseBtn.onclick=()=>{expenseModal.style.display="flex"; fillEmployeeSelect();}
modalCloseBtn.onclick=()=>{expenseModal.style.display="none"; modalAmount.value=""; modalNote.value=""; modalEmployee.value=""; modalOwner.value="";};

// ===== SAVE EXPENSE =====
modalSaveBtn.onclick=async()=>{
  const empId=modalEmployee.value;
  const ownerId=modalOwner.value;
  const amount=Number(modalAmount.value);
  const note=modalNote.value.trim();
  if(!empId || !ownerId || !amount) return alert("‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç");

  const res=await fetch(`${API}/expenses`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({employee:empId, owner:ownerId, amount, note})
  });
  if(res.ok){
    showToast("‡§ñ‡§∞‡•ç‡§ö ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ","success");
    expenseModal.style.display="none";
    modalAmount.value=""; modalNote.value=""; modalEmployee.value=""; modalOwner.value="";
    loadEmployees();
  }else{
    showToast("Error adding expense","error");
  }
}

// ===== TOAST =====
function showToast(msg,type){
  const box=document.createElement("div");
  box.className=`toast ${type}`;
  box.innerText=msg;
  document.getElementById("toastContainer").appendChild(box);
  setTimeout(()=>box.remove(),4000);
}

// ===== INITIAL LOAD =====
loadOwners();
loadEmployees();
</script>

</body>
</html>
