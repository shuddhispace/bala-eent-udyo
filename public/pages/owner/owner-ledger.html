<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --dark:#0f172a;
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --bg:#f1f5f9;
  --card:#ffffff;
}

*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:var(--bg);color:#111}

/* HEADER */
header{
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:#fff;
  padding:16px;
}
header h1{margin:0;font-size:18px}

/* SUMMARY */
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  padding:12px;
}
.summary-card{
  background:var(--card);
  border-radius:14px;
  padding:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  animation:fadeUp .4s ease;
}
.summary-card h4{margin:0 0 6px;font-size:13px;color:#555}
.summary-card strong{font-size:18px}

/* SEARCH */
.search-box{padding:12px}
.search-box input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
}

/* OWNERS */
.owners{
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding:12px;
}
.owner-card{
  min-width:280px;
  background:var(--card);
  border-radius:16px;
  padding:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
  animation:slideIn .4s ease;
}
.owner-card h3{margin:0 0 6px;font-size:16px}
.owner-row{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:4px 0;
}
.tag{
  font-size:12px;
  padding:4px 10px;
  border-radius:20px;
  display:inline-block;
  margin-top:6px;
}
.green{background:#dcfce7;color:#166534}
.red{background:#fee2e2;color:#991b1b}

/* FORMS */
.form-card{
  background:var(--card);
  margin:12px;
  padding:14px;
  border-radius:16px;
}
form{display:grid;gap:10px}
input,select,button{
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  background:var(--dark);
  color:#fff;
  border:none;
  cursor:pointer;
}

/* LEDGER */
.ledger-section{
  margin:12px;
  background:#fff;
  border-radius:16px;
  padding:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.ledger-table-wrapper{overflow-x:auto}

table{
  width:100%;
  border-collapse:collapse;
  min-width:720px;
}
thead{
  background:var(--dark);
  color:#fff;
}
th,td{
  padding:10px 12px;
  text-align:left;
  white-space:nowrap;
  font-size:14px;
}
tbody tr:nth-child(even){background:#f8fafc}
tbody tr:hover{background:#eef2ff}
.amt{text-align:right}

.type-invest{color:var(--primary);font-weight:600}
.type-profit{color:var(--success);font-weight:600}
.type-withdraw{color:var(--danger);font-weight:600}

.pos{color:var(--success);font-weight:600}
.neg{color:var(--danger);font-weight:600}

/* PAGINATION */
.pagination{
  display:flex;
  justify-content:center;
  gap:10px;
  padding:10px;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:none}
}
@keyframes slideIn{
  from{opacity:0;transform:translateX(20px)}
  to{opacity:1;transform:none}
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>üè≠ Owner P/L</h1>
</header>

<!-- SUMMARY -->
<div class="summary">
  <div class="summary-card">
    <h4>Total Investment</h4>
    <strong id="sumInvest">‚Çπ0</strong>
  </div>
  <div class="summary-card">
    <h4>Total Withdrawn</h4>
    <strong id="sumWithdraw">‚Çπ0</strong>
  </div>
  <div class="summary-card">
    <h4>Total Profit (Company)</h4>
    <strong id="sumProfit">‚Çπ0</strong>
  </div>
</div>

<div class="search-box">
  <input id="searchOwner" placeholder="Search owner">
</div>

<div class="owners" id="ownersList"></div>

<!-- ADD OWNER -->
<div class="form-card">
  <h3>Add Owner</h3>
  <form id="addOwnerForm">
    <input id="ownerNameInput" placeholder="Owner name" required>
    <button>Add Owner</button>
  </form>
</div>

<!-- ADD LEDGER -->
<div class="form-card">
  <h3>Add Ledger Entry</h3>
  <form id="ledgerForm">
    <select id="ownerSelect" required></select>
    <select id="typeSelect">
      <option value="INVEST">INVEST</option>
      <option value="PROFIT">PROFIT</option>
      <option value="WITHDRAW">WITHDRAW</option>
    </select>
    <input id="amountInput" type="number" placeholder="Amount" required>
    <input id="dateInput" type="datetime-local">
    <input id="noteInput" placeholder="Note">
    <button>Add Entry</button>
  </form>
</div>

<!-- LEDGER -->
<div class="ledger-section">
  <h3>üìí Ledger</h3>
  <div class="ledger-table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Owner</th>
          <th>Type</th>
          <th class="amt">Amount</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody id="ledgerBody"></tbody>
    </table>
  </div>
</div>

<div class="pagination">
  <button onclick="prevPage()">Prev</button>
  <span id="pageInfo"></span>
  <button onclick="nextPage()">Next</button>
</div>

<script>
const API="/api";

let owners=[], ledger=[], page=1, perPage=10;

const ownersList=document.getElementById("ownersList");
const ledgerBody=document.getElementById("ledgerBody");
const ownerSelect=document.getElementById("ownerSelect");
const searchOwner=document.getElementById("searchOwner");

function formatCurrency(num){ return '‚Çπ'+num.toLocaleString(); }

function debounce(fn, delay=300){
  let timer;
  return (...args)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...args), delay); };
}

async function loadAll(){
  owners = await (await fetch(API+"/owners")).json();
  ledger = await (await fetch(API+"/ledger")).json();
  renderSummary();
  renderOwners();
  renderLedger();
}

/* SUMMARY */
function renderSummary(){
  sumInvest.innerText = formatCurrency(ledger.filter(l=>l.type==="INVEST").reduce((s,l)=>s+l.amount,0));
  sumWithdraw.innerText = formatCurrency(ledger.filter(l=>l.type==="WITHDRAW").reduce((s,l)=>s+Math.abs(l.amount),0));
  sumProfit.innerText = formatCurrency(ledger.filter(l=>l.type==="PROFIT").reduce((s,l)=>s+l.amount,0));
}

/* OWNERS */
function renderOwners(){
  ownersList.innerHTML="";
  ownerSelect.innerHTML="";
  const frag = document.createDocumentFragment();

  const totalInvest = ledger.filter(l=>l.type==="INVEST").reduce((s,l)=>s+l.amount,0);
  const totalProfit = ledger.filter(l=>l.type==="PROFIT").reduce((s,l)=>s+l.amount,0);
  const keyword = searchOwner.value.toLowerCase();

  owners.filter(o=>o.name.toLowerCase().includes(keyword)).forEach(o=>{
    const invest = ledger.filter(l=>l.ownerId===o._id && l.type==="INVEST").reduce((s,l)=>s+l.amount,0);
    const withdraw = ledger.filter(l=>l.ownerId===o._id && l.type==="WITHDRAW").reduce((s,l)=>s+Math.abs(l.amount),0);
    const balance = invest - withdraw;
    const pct = totalInvest ? ((invest/totalInvest)*100).toFixed(2) : 0;
    const share = Math.round((pct/100)*totalProfit);

    const div = document.createElement("div");
    div.className = "owner-card";
    div.innerHTML=`
      <h3>${o.name}</h3>
      <div class="owner-row"><span>Invested</span><span>‚Çπ${invest}</span></div>
      <div class="owner-row"><span>Withdrawn</span><span>‚Çπ${withdraw}</span></div>
      <div class="owner-row"><span>Balance</span><span class="${balance>=0?'pos':'neg'}">‚Çπ${balance}</span></div>
      <div class="owner-row"><span>Profit Share</span><span>‚Çπ${share} (${pct}%)</span></div>
      <span class="tag ${balance<0?'red':'green'}">${balance<0?'Overdrawn':'OK'}</span>
    `;
    frag.appendChild(div);
    ownerSelect.innerHTML += `<option value="${o._id}">${o.name}</option>`;
  });
  ownersList.appendChild(frag);
}

/* LEDGER */
function renderLedger(){
  ledgerBody.innerHTML="";
  const keyword = searchOwner.value.toLowerCase();
  const ownerMap = {}; owners.forEach(o=>ownerMap[o._id]=o.name);

  const filtered = ledger.filter(l=> (ownerMap[l.ownerId]||"").toLowerCase().includes(keyword) );
  const start=(page-1)*perPage;
  const frag = document.createDocumentFragment();
  filtered.slice(start,start+perPage).forEach(l=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${new Date(l.date).toLocaleString()}</td>
      <td>${ownerMap[l.ownerId] || "-"}</td>
      <td class="type-${l.type.toLowerCase()}">${l.type}</td>
      <td class="amt ${l.amount>=0?'pos':'neg'}">‚Çπ${Math.abs(l.amount)}</td>
      <td>${l.note||"-"}</td>
    `;
    frag.appendChild(tr);
  });
  ledgerBody.appendChild(frag);
  pageInfo.innerText = `Page ${page} of ${Math.ceil(filtered.length/perPage) || 1}`;
}

/* PAGINATION */
function nextPage(){ page++; renderLedger(); }
function prevPage(){ if(page>1){ page--; renderLedger(); } }

/* FORMS */
addOwnerForm.onsubmit = async e=>{
  e.preventDefault();
  await fetch(API+"/owners",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({name:ownerNameInput.value})});
  ownerNameInput.value=""; loadAll();
};

ledgerForm.onsubmit = async e=>{
  e.preventDefault();
  await fetch(API+"/ledger",{method:"POST",headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      ownerId: ownerSelect.value,
      type: typeSelect.value,
      amount: typeSelect.value==="WITHDRAW"? -amountInput.value : +amountInput.value,
      date: dateInput.value || new Date(),
      note: noteInput.value
    })});
  ledgerForm.reset(); loadAll();
};

/* SEARCH */
searchOwner.addEventListener('input',debounce(()=>{ page=1; renderOwners(); renderLedger(); }));

loadAll();
</script>
</div>
</body>
</html>
