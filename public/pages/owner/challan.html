<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡§à‡§Ç‡§ü ‡§ö‡§æ‡§≤‡§æ‡§® | ‡§∂‡•ç‡§∞‡•Ä ‡§¨‡§æ‡§≤‡§æ‡§ú‡•Ä ‡§à‡§Ç‡§ü ‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:Poppins,sans-serif;margin:0;background:#f4f6fb}
header{background:#1f2937;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:600}
.container{max-width:1100px;margin:auto;padding:12px}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
h3{margin:0 0 10px}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd;font-family:inherit}
button{background:#2563eb;color:#fff;font-weight:600;cursor:pointer;border:none}
button.secondary{background:#10b981}
button.whatsapp{background:#25D366}
.msg{margin-top:10px;padding:10px;border-radius:8px;display:none}
.msg.success{background:#dcfce7;color:#166534}
.msg.error{background:#fee2e2;color:#991b1b}
.flex{display:flex;gap:12px;flex-wrap:wrap}
.flex>div{flex:1;min-width:220px}
table{width:100%;border-collapse:collapse;margin-top:10px;overflow-x:auto;display:block}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:13px;white-space:nowrap}
th{background:#f1f5f9;text-align:left}
.tabbar{display:flex;gap:10px;margin-bottom:10px}
.tabbar button{flex:1;background:#e5e7eb;color:#000}
.tabbar button.active{background:#2563eb;color:#fff}
@media(max-width:600px){th,td{font-size:12px}}
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:14px;
  margin-top:10px;
}

.brick-card{
  background:#f8fafc;
  border-radius:12px;
  padding:14px;
  border-left:6px solid #2563eb;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
}

.brick-card h4{
  margin:0 0 8px;
  font-size:15px;
  color:#1f2937;
}

.brick-card p{
  margin:4px 0;
  font-size:14px;
  color:#374151;
  font-weight:500;
}

.brick-card .amount{
  color:#065f46;
  font-weight:700;
}

.total-card{
  background:#ecfeff;
  border-left-color:#0ea5e9;
}

.total-card h4{
  color:#0f172a;
}

@media(max-width:600px){
  .brick-card{
    padding:12px;
  }
}
</style>
</head>

<body>
<header>üß± ‡§∂‡•ç‡§∞‡•Ä ‡§¨‡§æ‡§≤‡§æ‡§ú‡•Ä ‡§à‡§Ç‡§ü ‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó ‚Äì ‡§ö‡§æ‡§≤‡§æ‡§®</header>
<div class="container">

<!-- Tabs -->
<div class="tabbar">
  <button class="active" onclick="showTab('challan')">‡§ö‡§æ‡§≤‡§æ‡§®</button>
  <button onclick="showTab('advance')">Advance</button>
  <button onclick="showTab('history')">History</button>
</div>

<!-- CHALLAN TAB -->
<div id="tab-challan" class="card">
<h3>üßæ ‡§®‡§Ø‡§æ ‡§ö‡§æ‡§≤‡§æ‡§®</h3>
<div class="flex">
  <div><input id="mobile" placeholder="Buyer Mobile" /></div>
  <div><input id="address" placeholder="Buyer Address (optional)" /></div>
  <div>
    <select id="brick">
      <option>First Class Brick</option>
      <option>Second Class Brick</option>
      <option>Third Class (Sema)</option>
      <option>Khanjar Brick</option>
      <option>Gudiya Brick</option>
    </select>
  </div>
</div>
<div class="flex">
  <div><input id="qty" type="number" placeholder="Qty" /></div>
  <div><input id="amount" type="number" placeholder="Total Amount" /></div>
</div>
<button onclick="saveChallan()">Save Challan</button>
<div class="flex" id="pdfActions" style="margin-top:10px; display:none; gap:10px">
  <button id="downloadPDF" class="secondary">Download PDF</button>
  <button id="shareWhatsApp" class="whatsapp">Share WhatsApp</button>
</div>
<div class="msg success" id="challanSuccess"></div>
<div class="msg error" id="challanError"></div>
</div>

<!-- ADVANCE TAB -->
<div id="tab-advance" class="card" style="display:none">
<h3>üí∞ Advance Entry</h3>
<input id="aMobile" placeholder="Buyer Mobile" />
<input id="aName" placeholder="Buyer Name (optional)" />
<input id="aAddress" placeholder="Address (optional)" />
<input id="aAmount" type="number" placeholder="Advance Amount" />
<input id="aOwner" placeholder="Owner Name" />
<button class="secondary" onclick="addAdvance()">Add Advance</button>
<div class="msg success" id="advSuccess"></div>
<div class="msg error" id="advError"></div>
</div>

<!-- HISTORY TAB -->
<div id="tab-history" class="card" style="display:none">
<div class="card" id="brickSummaryCard">
  <h3>üìä ‡§à‡§Ç‡§ü ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Owner)</h3>
  <div id="brickSummaryList" class="summary-grid"></div>
</div>

<h3>üìú Challan History</h3>
<input id="search" placeholder="Search Buyer Name / Mobile / Challan No / Address" oninput="loadHistory()" />
<div style="overflow-x:auto">
<table>
<thead>
<tr>
<th>Challan</th><th>Buyer</th><th>Mobile</th><th>Address</th><th>Amt</th><th>Advance Used</th><th>Payable</th><th>Remaining Adv.</th><th>Date</th><th>PDF</th>
</tr>
</thead>
<tbody id="historyBody"></tbody>
</table>
</div>
<div style="margin-top:10px; display:flex; justify-content:center; gap:10px">
<button onclick="prevPage()">Prev</button>
<span id="pageNum">1</span>
<button onclick="nextPage()">Next</button>
</div>
</div>

</div>

<script>
// ------------------ GLOBALS ------------------
const apiBase = '/api';
let currentPage = 1;
let lastChallan = null;

// ------------------ TAB SWITCH ------------------
function showTab(tab) {
  document.querySelectorAll('.tabbar button').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  ['challan','advance','history'].forEach(t => document.getElementById(`tab-${t}`).style.display = t===tab?'block':'none');
  if(tab==='history') loadHistory();
}

// ------------------ SAFE FETCH ------------------
async function safeFetch(url, options={}) {
  try {
    const res = await fetch(url, options);
    const text = await res.text();
    return JSON.parse(text);
  } catch(e) {
    throw new Error('Server returned invalid JSON');
  }
}

// ------------------ ADVANCE ------------------
async function addAdvance() {
  advSuccess.style.display = advError.style.display = 'none';
  try {
    const data = await safeFetch(`${apiBase}/advances`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        mobile:aMobile.value,
        name:aName.value,
        address:aAddress.value,
        amount:aAmount.value,
        owner:aOwner.value
      })
    });
    if(!data.success) throw new Error(data.message);
    advSuccess.innerText='‚úÖ Advance Added Successfully';
    advSuccess.style.display='block';
    aMobile.value=aName.value=aAddress.value=aAmount.value=aOwner.value='';
  } catch(err){
    advError.innerText='‚ùå '+err.message;
    advError.style.display='block';
  }
}

// ------------------ SAVE CHALLAN ------------------
async function saveChallan() {
  challanSuccess.style.display = challanError.style.display = 'none';
  pdfActions.style.display='none';
  try{
    const data = await safeFetch(`${apiBase}/challans`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        mobile:mobile.value,
        address:address.value,
        brick:brick.value,
        qty:qty.value,
        amount:Number(amount.value)
      })
    });
    if(!data.success) throw new Error(data.message);
    challanSuccess.innerText='‚úÖ Challan Saved';
    challanSuccess.style.display='block';
    lastChallan=data.data;
    pdfActions.style.display='flex';
  } catch(err){
    challanError.innerText='‚ùå '+err.message;
    challanError.style.display='block';
  }
}

// ------------------ GENERATE PDF ------------------
function generatePDF(c) {
  if (!c) return alert('Challan data missing!');

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageW = 210;
  let y = 18;

  /* ================= HEADER ================= */
  pdf.setFillColor(37, 99, 235);
  pdf.rect(0, 0, pageW, 30, 'F');

  pdf.setTextColor(255);
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(18);
  pdf.text('SHREE BALAJI EENT UDYOG', pageW / 2, 14, { align: 'center' });

  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.text(
    'Sitholi Pani Tanki, Prayagraj, Uttar Pradesh',
    pageW / 2,
    22,
    { align: 'center' }
  );

  /* ================= BUYER DETAILS (LEFT-ALIGNED HEADER) ================= */
  y = 40;

  pdf.setTextColor(0);
  pdf.setFillColor(245, 245, 245);
  pdf.roundedRect(12, y, 186, 42, 5, 5, 'FD');

  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(11);
  pdf.text('Buyer Details', 16, y + 9);

  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(10);

  // Left column
  pdf.text(`Buyer Name: ${c.buyerName || '-'}`, 16, y + 18);
  pdf.text(`Mobile: ${c.buyerMobile || '-'}`, 16, y + 25);
  pdf.text(`Address: ${c.address || '-'}`, 16, y + 32);

  // Right column
  pdf.text(`Challan No: ${c.challanNo}`, 118, y + 18);
  pdf.text(
    `Date: ${new Date(c.createdAt).toLocaleDateString()}`,
    118,
    y + 25
  );
  pdf.text(
    `Time: ${new Date(c.createdAt).toLocaleTimeString()}`,
    118,
    y + 32
  );

  y += 55;

  /* ================= BRICK DETAILS ================= */
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(12);
  pdf.text('Brick Details', pageW / 2, y, { align: 'center' });

  y += 6;
  pdf.setFont('helvetica', 'normal');
  pdf.roundedRect(45, y, 120, 12, 6, 6, 'S');
  pdf.text(
    `Type: ${c.brick}  |  Quantity: ${c.qty}`,
    pageW / 2,
    y + 8,
    { align: 'center' }
  );

  y += 22;

  /* ================= AMOUNT SUMMARY ================= */
  const rows = [
    ['Total Amount', c.amount],
    ['Advance Used', c.advanceUsed],
    ['Payable Amount', c.payable],
    ['Remaining Advance', c.remainingAdvance]
  ];

  rows.forEach(r => {
    pdf.roundedRect(25, y, 160, 10, 4, 4, 'S');
    pdf.text(r[0], 30, y + 7);
    pdf.text(
      `Rs. ${Number(r[1] || 0).toLocaleString()}`,
      180,
      y + 7,
      { align: 'right' }
    );
    y += 12;
  });

  /* ================= PAYMENT STATUS ================= */
  const badgeText =
    c.payable <= 0 ? 'PAYMENT RECEIVED' : 'PAYMENT PENDING';

  const badgeW = 70;
  const badgeX = (pageW - badgeW) / 2;

  pdf.setFillColor(
    c.payable <= 0 ? 220 : 254,
    c.payable <= 0 ? 252 : 226,
    c.payable <= 0 ? 231 : 226
  );
  pdf.roundedRect(badgeX, y, badgeW, 10, 6, 6, 'F');

  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(11);
  pdf.setTextColor(
    c.payable <= 0 ? 22 : 185,
    c.payable <= 0 ? 163 : 28,
    0
  );
  pdf.text(badgeText, pageW / 2, y + 7, { align: 'center' });

  y += 18;

  /* ================= UPI PAYMENT ================= */
  const upiId = 'ajayk20166@okhdfcbank';
  const upiUrl = `upi://pay?pa=${upiId}&pn=Shree Balaji Eent Udyog`;

  pdf.setFillColor(224, 242, 254);
  pdf.roundedRect(30, y, 150, 22, 8, 8, 'FD');

  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(3, 105, 161);
  pdf.text('Pay via UPI', pageW / 2, y + 9, { align: 'center' });

  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(10);
  pdf.textWithLink(`UPI ID: ${upiId}`, pageW / 2, y + 16, {
    align: 'center',
    url: upiUrl
  });

  y += 30;

  /* ================= THANK YOU ================= */
  pdf.setFillColor(220, 252, 231);
  pdf.roundedRect(20, y, 170, 24, 8, 8, 'FD');

  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(22, 101, 52);
  pdf.text('THANK YOU', pageW / 2, y + 9, { align: 'center' });

  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(10);
  pdf.text(
    'Thank you for choosing Shree Balaji Eent Udyog.\nWe truly appreciate your business.',
    pageW / 2,
    y + 16,
    { align: 'center' }
  );

  /* ================= CONTACT DETAILS ================= */
  y = 250;

  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(0);
  pdf.text('Contact Details', pageW / 2, y, { align: 'center' });

  y += 7;
  pdf.setFont('helvetica', 'normal');
  pdf.textWithLink('Ajay: 9839454542', pageW / 2 - 30, y, {
    url: 'tel:9839454542'
  });
  pdf.textWithLink('Rahul: 8736002647', pageW / 2 + 10, y, {
    url: 'tel:8736002647'
  });

  /* ================= FOOTER ================= */
  pdf.setDrawColor(200);
  pdf.line(15, 280, 195, 280);
  pdf.setFontSize(9);
  pdf.setTextColor(120);
  pdf.text(
    'This is a computer generated challan',
    pageW / 2,
    287,
    { align: 'center' }
  );

  pdf.save(`${c.challanNo}.pdf`);
}

// ------------------ DOWNLOAD & WHATSAPP ------------------
downloadPDF.onclick=()=>{
  if(!lastChallan) return alert("Please save a challan first!");
  generatePDF(lastChallan);
};

shareWhatsApp.onclick=()=>{
  if(!lastChallan) return alert("Please save a challan first!");
  generatePDF(lastChallan);
  const msg=`Shree Balaji Eent Udyog
Buyer Name: ${lastChallan.buyerName||'-'}
Mobile: ${lastChallan.buyerMobile||'-'}
Address: ${lastChallan.address||'-'}
Challan No: ${lastChallan.challanNo}
Brick Type: ${lastChallan.brick}
Quantity: ${lastChallan.qty}
Total Amount: ‚Çπ${lastChallan.amount}
Payable Amount: ‚Çπ${lastChallan.payable}
Thank you for your business.`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
};

// ------------------ HISTORY ------------------
async function loadHistory(){
  const s=document.getElementById('search').value.toLowerCase();
  const data=await safeFetch(`${apiBase}/challans?page=${currentPage}`);
  if(!data.data) return;

  // Filter client-side
  const filtered=data.data.filter(c=>{
    return (c.buyerName && c.buyerName.toLowerCase().includes(s))||
           (c.buyerMobile && c.buyerMobile.toLowerCase().includes(s))||
           (c.address && c.address.toLowerCase().includes(s))||
           (c.challanNo && c.challanNo.toLowerCase().includes(s));
  });

  historyBody.innerHTML='';
  filtered.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.challanNo}</td>
<td>${c.buyerName||'-'}</td>
<td>${c.buyerMobile||'-'}</td>
<td>${c.address||'-'}</td>
<td>‚Çπ${c.amount}</td>
<td>‚Çπ${c.advanceUsed}</td>
<td>‚Çπ${c.payable}</td>
<td style="font-weight:600;color:${c.remainingAdvance>0?'#166534':'#991b1b'}">‚Çπ${c.remainingAdvance}</td>
<td>${new Date(c.createdAt).toLocaleString()}</td>
<td><button class="pdfBtn">üìÑ PDF</button></td>`;
    tr.querySelector('.pdfBtn').addEventListener('click',()=>generatePDF(c));
    historyBody.appendChild(tr);
  });

  lastChallan=filtered[0]||lastChallan;
  pageNum.innerText=currentPage;
}

// ------------------ PAGINATION ------------------
function prevPage(){if(currentPage>1){currentPage--; loadHistory();}}
function nextPage(){currentPage++; loadHistory();}

// ------------------ BRICK SUMMARY ------------------
function renderBrickSummary(challans){
  const box=document.getElementById('brickSummaryList');
  const map={}; let totalQty=0,totalAmount=0;
  challans.forEach(c=>{
    if(!map[c.brick]) map[c.brick]={qty:0,amount:0};
    map[c.brick].qty+=Number(c.qty||0);
    map[c.brick].amount+=Number(c.amount||0);
    totalQty+=Number(c.qty||0);
    totalAmount+=Number(c.amount||0);
  });
  const html=Object.keys(map).map(brick=>`<div class="brick-card">
<h4>${brick}</h4>
<p>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ : <b>${map[brick].qty}</b></p>
<p class="amount">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä : ‚Çπ${map[brick].amount}</p>
</div>`).join('');
  box.innerHTML=html+`<div class="brick-card total-card">
<h4>‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó</h4>
<p>‡§ï‡•Å‡§≤ ‡§à‡§Ç‡§ü : <b>${totalQty}</b></p>
<p class="amount">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø : ‚Çπ${totalAmount}</p>
</div>`;
}
</script>
</body>
</html>
