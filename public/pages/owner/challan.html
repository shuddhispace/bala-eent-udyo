<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡§à‡§Ç‡§ü ‡§ö‡§æ‡§≤‡§æ‡§® | ‡§∂‡•ç‡§∞‡•Ä ‡§¨‡§æ‡§≤‡§æ‡§ú‡•Ä ‡§à‡§Ç‡§ü ‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:Poppins,sans-serif;margin:0;background:#f4f6fb}
header{background:#1f2937;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:600}
.container{max-width:1100px;margin:auto;padding:12px}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
h3{margin:0 0 10px}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd;font-family:inherit}
button{background:#2563eb;color:#fff;font-weight:600;cursor:pointer;border:none}
button.secondary{background:#10b981}
button.whatsapp{background:#25D366}
.msg{margin-top:10px;padding:10px;border-radius:8px;display:none}
.msg.success{background:#dcfce7;color:#166534}
.msg.error{background:#fee2e2;color:#991b1b}
.flex{display:flex;gap:12px;flex-wrap:wrap}
.flex>div{flex:1;min-width:220px}
table{width:100%;border-collapse:collapse;margin-top:10px;overflow-x:auto;display:block}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:13px;white-space:nowrap}
th{background:#f1f5f9;text-align:left}
.tabbar{display:flex;gap:10px;margin-bottom:10px}
.tabbar button{flex:1;background:#e5e7eb;color:#000}
.tabbar button.active{background:#2563eb;color:#fff}
@media(max-width:600px){th,td{font-size:12px}}
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:14px;
  margin-top:10px;
}

.brick-card{
  background:#f8fafc;
  border-radius:12px;
  padding:14px;
  border-left:6px solid #2563eb;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
}

.brick-card h4{
  margin:0 0 8px;
  font-size:15px;
  color:#1f2937;
}

.brick-card p{
  margin:4px 0;
  font-size:14px;
  color:#374151;
  font-weight:500;
}

.brick-card .amount{
  color:#065f46;
  font-weight:700;
}

.total-card{
  background:#ecfeff;
  border-left-color:#0ea5e9;
}

.total-card h4{
  color:#0f172a;
}

@media(max-width:600px){
  .brick-card{
    padding:12px;
  }
}


</style>
</head>

<body>
<header>üß± ‡§∂‡•ç‡§∞‡•Ä ‡§¨‡§æ‡§≤‡§æ‡§ú‡•Ä ‡§à‡§Ç‡§ü ‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó ‚Äì ‡§ö‡§æ‡§≤‡§æ‡§®</header>
<div class="container">

<div class="tabbar">
  <button class="active" onclick="showTab('challan')">‡§ö‡§æ‡§≤‡§æ‡§®</button>
  <button onclick="showTab('advance')">Advance</button>
  <button onclick="showTab('history')">History</button>
</div>

<!-- CHALLAN TAB -->
<div id="tab-challan" class="card">
<h3>üßæ ‡§®‡§Ø‡§æ ‡§ö‡§æ‡§≤‡§æ‡§®</h3>
<div class="flex">
  <div><input id="mobile" placeholder="Buyer Mobile" /></div>
  <div>
    <select id="brick">
      <option>First Class Brick</option>
      <option>Second Class Brick</option>
      <option>Third Class (Sema)</option>
      <option>Khanjar Brick</option>
      <option>Gudiya Brick</option>
    </select>
  </div>
</div>
<div class="flex">
  <div><input id="qty" type="number" placeholder="Qty" /></div>
  <div><input id="amount" type="number" placeholder="Total Amount" /></div>
</div>
<button onclick="saveChallan()">Save Challan</button>
<div class="flex" id="pdfActions" style="margin-top:10px; display:none; gap:10px">
  <button id="downloadPDF" class="secondary">Download PDF</button>
  <button id="shareWhatsApp" class="whatsapp">Share WhatsApp</button>
</div>
<div class="msg success" id="challanSuccess"></div>
<div class="msg error" id="challanError"></div>
</div>

<!-- ADVANCE TAB -->
<div id="tab-advance" class="card" style="display:none">
<h3>üí∞ Advance Entry</h3>
<input id="aMobile" placeholder="Buyer Mobile" />
<input id="aName" placeholder="Buyer Name (optional)" />
<input id="aAddress" placeholder="Address (optional)" />
<input id="aAmount" type="number" placeholder="Advance Amount" />
<input id="aOwner" placeholder="Owner Name" />
<button class="secondary" onclick="addAdvance()">Add Advance</button>
<div class="msg success" id="advSuccess"></div>
<div class="msg error" id="advError"></div>
</div>

<!-- HISTORY TAB -->
<div id="tab-history" class="card" style="display:none">
<div class="card" id="brickSummaryCard">
  <h3>üìä ‡§à‡§Ç‡§ü ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Owner)</h3>
  <div id="brickSummaryList" class="summary-grid"></div>
</div>

<h3>üìú Challan History</h3>
<input id="search" placeholder="Search Buyer Name / Mobile" oninput="loadHistory()" />
<div style="overflow-x:auto">
<table>
<thead>
<tr>
<th>Challan</th><th>Buyer</th><th>Mobile</th><th>Amt</th><th>Advance Used</th><th>Payable</th><th>Remaining Adv.</th><th>Date</th><th>PDF</th>
</tr>
</thead>
<tbody id="historyBody"></tbody>
</table>
</div>
<div style="margin-top:10px; display:flex; justify-content:center; gap:10px">
<button onclick="prevPage()">Prev</button>
<span id="pageNum">1</span>
<button onclick="nextPage()">Next</button>
</div>
</div>
</div>

<script>
const apiBase='/api';
let page=1;
let lastData=null;
function showTab(tab){document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');document.getElementById('tab-challan').style.display='none';document.getElementById('tab-advance').style.display='none';document.getElementById('tab-history').style.display='none';document.getElementById('tab-'+tab).style.display='block';if(tab==='history') loadHistory()}
async function safeFetch(url,options){const res=await fetch(url,options);const text=await res.text();try{return JSON.parse(text)}catch{throw new Error('Server returned HTML instead of JSON')}}
async function addAdvance(){advSuccess.style.display='none';advError.style.display='none';try{const data=await safeFetch(apiBase+'/advances',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mobile:aMobile.value,name:aName.value,address:aAddress.value,amount:aAmount.value,owner:aOwner.value})});if(!data.success)throw new Error(data.message);advSuccess.innerText='‚úÖ Advance Added Successfully';advSuccess.style.display='block';aMobile.value=aName.value=aAddress.value=aAmount.value=aOwner.value=''}catch(err){advError.innerText='‚ùå '+err.message;advError.style.display='block'}}
async function saveChallan(){challanSuccess.style.display='none';challanError.style.display='none';pdfActions.style.display='none';try{const data=await safeFetch(apiBase+'/challans',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mobile:mobile.value,brick:brick.value,qty:qty.value,amount:Number(amount.value)})});if(!data.success)throw new Error(data.message);challanSuccess.innerText='‚úÖ Challan Saved';challanSuccess.style.display='block';lastData=data.data;pdfActions.style.display='flex'}catch(err){challanError.innerText='‚ùå '+err.message;challanError.style.display='block'}}
downloadPDF.onclick=function(){if(lastData)generatePDF(lastData)}
shareWhatsApp.onclick = function () {
  if (!lastData) return;

  // 1Ô∏è‚É£ Download PDF first
  generatePDF(lastData);

  // 2Ô∏è‚É£ WhatsApp message (Emoji Color Style)
  const msg = `üü¶üß± *‡§∂‡•ç‡§∞‡•Ä ‡§¨‡§æ‡§≤‡§æ‡§ú‡•Ä ‡§à‡§Ç‡§ü ‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó* üß±üü¶

üôè ‡§®‡§Æ‡§∏‡•ç‡§§‡•á  
‡§Ü‡§™‡§ï‡•á *‡§ö‡§æ‡§≤‡§æ‡§® ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£* ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à üëá

üü®üßæ *‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç‡§¨‡§∞:* ${lastData.challanNo}

üü¶üë§ *‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ:* ${lastData.buyerName}  
üü¶üì± *‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞:* ${lastData.buyerMobile}

üü´üß± *‡§à‡§Ç‡§ü ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:* ${lastData.brick}  
üü´üì¶ *‡§ï‡•Å‡§≤ ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ:* ${lastData.qty}

üü¢üí∞ *‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø:* ‚Çπ${lastData.amount}  
üî¥üíµ *‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø:* ‚Çπ${lastData.payable}

üìÑ‚ö†Ô∏è *‡§ï‡•É‡§™‡§Ø‡§æ ‡§ö‡§æ‡§≤‡§æ‡§® ‡§ï‡•Ä PDF ‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§ï‡§∞‡•á‡§Ç‡•§*

üôè *‡§Ü‡§™‡§ï‡•á ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§î‡§∞ ‡§∏‡§π‡§Ø‡•ã‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶*  
‚Äî *‡§∂‡•ç‡§∞‡•Ä ‡§¨‡§æ‡§≤‡§æ‡§ú‡•Ä ‡§à‡§Ç‡§ü ‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó* üß±`;

  window.open(
    `https://wa.me/?text=${encodeURIComponent(msg)}`,
    "_blank"
  );
};


function generatePDF(c) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  let y = 18;

  /* ===== HEADER ===== */
  pdf.setFillColor(37, 99, 235);
  pdf.rect(0, 0, 210, 30, "F");

  pdf.setTextColor(255);
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(18);
  pdf.text("SHREE BALAJI EENT UDYOG", 105, 14, { align: "center" });

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(10);
  pdf.text(
    "Sitholi Pani Tanki, Prayagraj, Uttar Pradesh",
    105,
    22,
    { align: "center" }
  );

  y = 40;
  pdf.setTextColor(0);
  pdf.setFontSize(11);

  /* ===== BUYER & CHALLAN INFO ===== */
  pdf.setFillColor(245, 245, 245);
  pdf.roundedRect(12, y, 186, 42, 4, 4, "FD");

  // Left
  pdf.text(`Buyer Name: ${c.buyerName || "-"}`, 16, y + 10);
  pdf.text(`Mobile: ${c.buyerMobile || "-"}`, 16, y + 18);
  pdf.text(`Address: ${c.address || "-"}`, 16, y + 26);

  // Right
  pdf.text(`Challan No: ${c.challanNo}`, 120, y + 10);
  pdf.text(
    `Date: ${new Date(c.createdAt).toLocaleDateString()}`,
    120,
    y + 18
  );
  pdf.text(
    `Time: ${new Date(c.createdAt).toLocaleTimeString()}`,
    120,
    y + 26
  );

  y += 52;

  /* ===== BRICK DETAILS ===== */
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(12);
  pdf.text("Brick Details", 105, y, { align: "center" });

  y += 6;
  pdf.setFont("helvetica", "normal");
  pdf.roundedRect(40, y, 130, 12, 4, 4, "S");
  pdf.text(
    `Type: ${c.brick}   |   Quantity: ${c.qty}`,
    105,
    y + 8,
    { align: "center" }
  );

  y += 22;

  /* ===== AMOUNT SUMMARY ===== */
  const summary = [
    ["Total Amount", c.amount],
    ["Advance Used", c.advanceUsed],
    ["Payable Amount", c.payable],
    ["Remaining Advance", c.remainingAdvance],
  ];

  summary.forEach((row) => {
    pdf.roundedRect(25, y, 160, 10, 3, 3, "S");
    pdf.text(row[0], 30, y + 7);
    pdf.text(
      `Rs. ${Number(row[1] || 0).toLocaleString()}`,
      175,
      y + 7,
      { align: "right" }
    );
    y += 12;
  });

  y += 8;

  /* ===== PAYMENT STATUS ===== */
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(12);
  pdf.setTextColor(c.payable <= 0 ? 22 : 185, c.payable <= 0 ? 163 : 28, 0);
  pdf.text(
    c.payable <= 0 ? "PAYMENT RECEIVED" : "PAYMENT PENDING",
    105,
    y,
    { align: "center" }
  );

  y += 12;

  /* ===== THANK YOU MESSAGE ===== */
  pdf.setFillColor(220, 252, 231);
  pdf.roundedRect(20, y, 170, 26, 6, 6, "FD");

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(12);
  pdf.setTextColor(22, 101, 52);
  pdf.text("THANK YOU", 105, y + 10, { align: "center" });

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(10);
  pdf.text(
    "Thank you for choosing Shree Balaji Eent Udyog.\nWe truly appreciate your business.",
    105,
    y + 18,
    { align: "center" }
  );

  y += 38;

  /* ===== OWNER CONTACT ===== */
  pdf.setFontSize(10);
  pdf.setTextColor(0);
  pdf.text("Contact Details", 105, y, { align: "center" });

  y += 6;
  pdf.text(
    "Ajay: 9839454542   |   Rahul: 8736002647",
    105,
    y,
    { align: "center" }
  );

  /* ===== FOOTER ===== */
  pdf.setDrawColor(200);
  pdf.line(15, 280, 195, 280);
  pdf.setFontSize(9);
  pdf.setTextColor(120);
  pdf.text(
    "This is a computer generated challan",
    105,
    287,
    { align: "center" }
  );

  pdf.save(`${c.challanNo}.pdf`);
}


let currentPage=1;
async function loadHistory(){const s=search.value||'';const data=await safeFetch(`${apiBase}/challans?search=${s}&page=${currentPage}`);lastData=data.data;
  // üëë OWNER SUMMARY (‡§Ø‡§π‡•Ä Step 4 ‡§π‡•à)
  renderBrickSummary(data.data);
historyBody.innerHTML='';data.data.forEach(c=>{historyBody.innerHTML+=`<tr><td>${c.challanNo}</td><td>${c.buyerName}</td><td>${c.buyerMobile}</td><td>‚Çπ${c.amount}</td><td>‚Çπ${c.advanceUsed}</td><td>‚Çπ${c.payable}</td><td style="font-weight:600;color:${c.remainingAdvance>0?'#166534':'#991b1b'}">‚Çπ${c.remainingAdvance}</td><td>${new Date(c.createdAt).toLocaleString()}</td> <td>
    <button onclick='generatePDF(${JSON.stringify(c)})'>
      üìÑ PDF
    </button>
  </td></tr>`});pageNum.innerText=currentPage}
function prevPage(){if(currentPage>1){currentPage--;loadHistory()}}
function nextPage(){currentPage++;loadHistory()}
function renderBrickSummary(challans){
  const box = document.getElementById('brickSummaryList');
  box.innerHTML = '';

  const map = {};
  let grandQty = 0;
  let grandAmount = 0;

  challans.forEach(c => {
    if(!map[c.brick]){
      map[c.brick] = { qty:0, amount:0 };
    }
    map[c.brick].qty += Number(c.qty || 0);
    map[c.brick].amount += Number(c.amount || 0);

    grandQty += Number(c.qty || 0);
    grandAmount += Number(c.amount || 0);
  });
Object.keys(map).forEach(brick => {
  box.innerHTML += `
    <div class="brick-card">
      <h4>üß± ${brick}</h4>
      <p>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ : <b>${map[brick].qty}</b></p>
      <p class="amount">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä : ‚Çπ${map[brick].amount}</p>
    </div>
  `;
});

box.innerHTML += `
  <div class="brick-card total-card">
    <h4>üî¢ ‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó</h4>
    <p>‡§ï‡•Å‡§≤ ‡§à‡§Ç‡§ü : <b>${grandQty}</b></p>
    <p class="amount">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø : ‚Çπ${grandAmount}</p>
  </div>
`;

}

</script>
</body>
</html>
