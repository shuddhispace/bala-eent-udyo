<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Dashboard â€¢ Pathira Advance</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;background:#f4f6fa;margin:0}
header{background:#b53030;color:#fff;padding:16px;font-weight:600}

.container{max-width:1200px;margin:auto;padding:16px}

.section{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.08)
}

h3{margin-bottom:12px;color:#b53030}

input,select,button{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  font-family:Poppins
}

button{
  background:#b53030;
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:600
}

.filters{
  display:flex;
  gap:10px;
  flex-wrap:wrap
}

.summary{
  display:flex;
  gap:14px;
  flex-wrap:wrap
}

.card{
  background:#fff;
  padding:14px;
  border-radius:14px;
  min-width:200px;
  box-shadow:0 8px 18px rgba(0,0,0,.08)
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px
}

th,td{
  padding:10px;
  border-bottom:1px solid #eee;
  font-size:14px
}

thead{background:#f2f2f2}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  align-items:center;
  justify-content:center
}

.modal-box{
  background:#fff;
  padding:20px;
  border-radius:16px;
  width:90%;
  max-width:420px
}
</style>
</head>

<body>

<header>Owner Dashboard â€¢ Pathira Advance</header>

<div class="container">

  <!-- ACTION -->
  <div class="section">
    <button onclick="openModal()">âž• Give Advance</button>
    <button onclick="window.open('challan.html','_blank')">
  ðŸ§¾ Generate Challan
</button>
  </div>


  <!-- FILTERS -->
  <div class="section">
    <h3>Advanced Filters</h3>
    <div class="filters">
      <input id="filterName" placeholder="Worker name">
      <select id="filterPurpose">
        <option value="">All Purpose</option>
        <option value="Pathira">Pathira</option>
        <option value="Nikasi">Nikasi</option>
      </select>
      <button onclick="loadData()">Search</button>
      <button onclick="resetFilter()" style="background:#777">Reset</button>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="section">
    <h3>Summary</h3>
    <div class="summary">
      <div class="card">
        <small>Total Records</small>
        <h3 id="totalCount">0</h3>
      </div>
      <div class="card">
        <small>Total Advance Amount</small>
        <h3 id="totalAmount">â‚¹ 0</h3>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="section">
    <h3>Advance Records</h3>
    <table>
      <thead>
        <tr>
          <th>Worker</th>
          <th>Amount</th>
          <th>Purpose</th>
          <th>Unit</th>
          <th>Date</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3>Give Advance</h3>

    <input id="w" placeholder="Worker Name"><br><br>
    <input id="a" type="number" placeholder="Amount"><br><br>

    <select id="p">
      <option value="Pathira">Pathira</option>
      <option value="Nikasi">Nikasi</option>
    </select><br><br>

    <input id="u" value="Unit-1"><br><br>

    <button onclick="save()">Save</button>
    <button onclick="closeModal()" style="background:#ccc;color:#000">Cancel</button>
  </div>
</div>

<!-- POST FORM -->
<form id="postForm"
  action="https://script.google.com/macros/s/AKfycbzPBjI7WZK5xBPeZ-ANrrCemBv5rGEwFhfYLmVKoeZXOI329L40HZGFVYm6le5yEwsFWQ/exec"
  method="POST"
  target="hiddenFrame">
  <input type="hidden" name="worker_name" id="fw">
  <input type="hidden" name="amount" id="fa">
  <input type="hidden" name="purpose" id="fp">
  <input type="hidden" name="production_unit" id="fu">
</form>

<iframe name="hiddenFrame" id="hiddenFrame" style="display:none"></iframe>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzPBjI7WZK5xBPeZ-ANrrCemBv5rGEwFhfYLmVKoeZXOI329L40HZGFVYm6le5yEwsFWQ/exec";
const iframe = document.getElementById("hiddenFrame");

/* MODAL */
function openModal(){ modal.style.display="flex"; }
function closeModal(){ modal.style.display="none"; }

/* SAVE ADVANCE */
function save(){
  if(!w.value || !a.value){
    alert("Worker name and amount required");
    return;
  }

  fw.value = w.value.trim();
  fa.value = a.value;
  fp.value = p.value;
  fu.value = u.value || "Unit-1";

  iframe.onload = function(){
    alert("âœ… Advance added successfully");
    loadData();
    iframe.onload = null;
  };

  postForm.submit();
  closeModal();

  w.value="";
  a.value="";
}

/* LOAD DATA + TOTAL */
function loadData(){
  const name = filterName.value;
  const purpose = filterPurpose.value;

  tableBody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

  fetch(`${API_URL}?name=${encodeURIComponent(name)}&purpose=${encodeURIComponent(purpose)}`)
    .then(r=>r.json())
    .then(data=>{
      tableBody.innerHTML="";
      let total = 0;

      data.forEach(r=>{
        total += Number(r.amount) || 0;

        const dt = new Date(r.created_date);
        const date = dt.toLocaleDateString("en-IN");
        const time = dt.toLocaleTimeString("en-IN");

        tableBody.innerHTML += `
          <tr>
            <td>${r.worker_name}</td>
            <td>â‚¹ ${r.amount}</td>
            <td>${r.purpose}</td>
            <td>${r.production_unit}</td>
            <td>${date}</td>
            <td>${time}</td>
          </tr>`;
      });

      totalCount.innerText = data.length;
      totalAmount.innerText = "â‚¹ " + total;
    });
}

/* RESET FILTER */
function resetFilter(){
  filterName.value="";
  filterPurpose.value="";
  loadData();
}

/* INITIAL LOAD */
loadData();
</script>


</body>
</html>
